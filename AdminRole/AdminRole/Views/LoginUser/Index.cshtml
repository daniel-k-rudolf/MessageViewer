@model AdminRole.Models.SpremenljivkeView

@using AdminRole.Models
@using AdminRole.Helpers
@using System.Web.Mvc.Html

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    
    string userName = System.Web.HttpContext.Current.User.Identity.Name;
    using (var dbUs = new userDbEntities())
    {
        var currentUser = dbUs.UsersTables.FirstOrDefault(u => u.username == userName);
        if (currentUser != null)
        {
            
            if (currentUser.VlogaUporabnika.Id_Vloga == VlogaEnum.Spediter)
            {
                using (Html.BeginForm("Index", "LoginUser", FormMethod.Get))
                {
                   <!-- /.Search menu -->
                    <section class="header">
                        <div class="container top">
                            <div class="row">
                                <div class="col-md-12">
                                    <nav class="navbar">
                                        <div class="container-fluid">
                                            <!-- Collect the nav links, forms, and other content for toggling -->
                                            <div>
                                                <p class="navbar-text">Stranka:</p>
                                                <div class="navbar-form navbar-left" role="search">
                                                    <div class="form-group">
                                                        @Html.DropDownList("destination", ((SelectList)ViewBag.DropList).Select(t => new SelectListItem() {Text = t.Text, Value = t.Text, Selected = (t.Text == ViewBag.Destination)}), "-- Izberi vse --", new{@class="form-control"})
                                                    </div>
                                                </div>
                                                <div class="navbar-right">
                                                    <div class="navbar-form navbar-left" role="search">
                                                        <div class="form-group">
                                                            @Html.TextBox("order", Model.Search.Order, new { placeholder="Luška št.", id ="quantity1", @class="quantity form-control"})
                                                        </div>
                                                        <div class="form-group">
                                                            @Html.TextBox("internal", Model.Search.Internal, new { placeholder="Interna št.", id ="quantity2", @class="quantity form-control", maxlength = 6})
                                                        </div>
                                                        <div class="form-group">
                                                            @Html.TextBox("exchangetimestamp", Model.Search.Exchangetimestamp, new { @class = "datepicker form-control", placeholder="Datum od" })
                                                        </div>
                                                        <div class="form-group">
                                                            @Html.TextBox("exchangetimestamp2", Model.Search.Exchangetimestamp2, new { @class = "datepicker form-control", placeholder="Datum do" })
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">Išči...</button>
                                                    </div>
                                                </div>
                                            </div><!-- /.navbar-collapse -->
                                        </div><!-- /.container-fluid -->
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </section>
    
                    <div class="container">                                      
                        <div class="template">
                        <table class="table table-bordered table-striped table-hover">
		                    <thead>
			                <tr>
                                <th>Interna št.</th>
                                <th>Sporočilo</th>
                                <th>Pošiljatelj</th>
                                <th>Prejemnik</th>
                                <th>Luška št.</th>
                                <th>Datum dogodka</th>
                                <th>Detajli</th>
			                </tr>
		                    </thead>
                            <tbody>
                                @if (Model.Spremenljivke != null)
                                {
                                    foreach (var row in Model.Spremenljivke)
                                    {
                                        <tr>
                                            <td>@row.Internal.First()</td>
                                            <td>
                                                @String.Join("", new userDbEntities().KraticeTables.Where(rt => rt.Kratica == row.MsgT.FirstOrDefault()).Select(r => r.OpisSlo).FirstOrDefault() ?? row.MsgT.FirstOrDefault())
                                            </td>
                                            <td>@row.Sender.First()</td>
                                            <td>@row.Destination.First()</td>
                                            <td>@row.Order.First()</td>
                                            <td>@row.Exchangetimestamp.Add(Model.TimeZone.BaseUtcOffset)</td>
                                            <td>
                                                <a href="#" data-toggle="modal" data-target="#myModal">View</a>
                                                <!-- Modal -->
                                                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                                    <div class="modal-dialog">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                                                <h4 class="modal-title" id="myModalLabel">Detajli</h4>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div style="display: block">

                                                                    <p class="pscript">
                                                                        Interna št.: <b>@Html.Raw(row.Internal.First())</b>
                                                                    </p>

                                                                    <p class="pscript">
                                                                        Sekvenčni Id: <b>@Html.Raw(row.Sequ)</b>, Sporočilo: <b>@Html.Raw(row.MsgT.First())</b>
                                                                    </p>

                                                                    <p class="pscript">
                                                                        Pošiljatelj: <b>@Html.Raw(row.Sender.First())</b> Prejemnik: <b>@Html.Raw(row.Destination.First())</b> z Luško št: <b>@Html.Raw(row.Order.First())</b>
                                                                    </p>

                                                                    <p class="pscript">
                                                                        Datum: <b>@Html.Raw(row.Exchangetimestamp.Add(Model.TimeZone.BaseUtcOffset))</b>
                                                                    </p>

                                                                    <p class="pscript">
                                                                        Status: <b>@Html.Raw(row.MsgS)</b>
                                                                    </p>

                                                                    <p class="pscript">
                                                                        Podrobne informacije:
                                                                    </p>
                                                                    <div>
                                                                        <code>
                                                                            <pre>@Html.Raw(Html.Encode(row.Data))</pre>
                                                                        </code>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-default" data-dismiss="modal">Zapri</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>                      
                                        </tr>
                                    }
                                }                      
                            </tbody>
		                </table>
                        </div>
		                <div class="row">
		                    <div class="col-md-6">
                                @{ Html.RenderPartial("Pagination", new PaginationInfo
                                {
                                    PageUrl = Url.SetParameter("page", "!0"),
                                    CurrentPage = Model.Search.PageIndex,
                                    PageSize = Model.Search.PageSize,
                                    TotalItemCount = Model.TotalCount,
                                }); }
		                    </div>                               
		                    <div class="col-md-6">
		                        <ul class="pagination pull-right">
		                            @{int allItems = Model.TotalCount;}
		                            <li><a href="#">Zadetkov na stran: </a></li>
		                            @{
                                        if (allItems != 0)
                                        {
                                            var arr = new[] { 5, 10, 20, 30 };
                                            for (var i = 0; i < arr.Length; i++)
                                            {
                                                if (arr[i] == Model.Search.PageSize)
                                                {
                                                    <li><a href="#">@arr[i]</a></li>
                                                }
                                                else
                                                {
		                                            <li><a href="@Url.SetParameters(new { pagesize = arr[i], page = 1 })">@arr[i]</a></li>
                                                }
                                            }
                                        }
                                        else
                                        {
		                                    <li><a href="#">--</a></li>
                                        }
		                            }

		                        </ul>
		                    </div>
		                </div>
		                <div class="row">
			                <div class="col-md-12">
				                <hr />
				                &copy; Actual I.T., d.d. 
			                </div>
		                </div>	
                    </div><!-- /.container -->
                
                }
            }
            else if (currentUser.VlogaUporabnika.Id_Vloga == VlogaEnum.SpediterOsnovni)
            {
                using (Html.BeginForm("Index", "LoginSimpleUser", FormMethod.Get))
                {
                                        <!-- /.Search menu -->
                    <section class="header">
                        <div class="container top">
                            <div class="row">
                                <div class="col-md-12">
                                    <nav class="navbar">
                                        <div class="container-fluid">
                                            <!-- Collect the nav links, forms, and other content for toggling -->
                                            <div>
                                                <p class="navbar-text">Stranka:</p>
                                                <div class="navbar-form navbar-left" role="search">
                                                    <div class="form-group">
                                                        @Html.DropDownList("destination", ((SelectList)ViewBag.DropList).Select(t => new SelectListItem() {Text = t.Text, Value = t.Text, Selected = (t.Text == ViewBag.Destination)}), new{@class="form-control"})
                                                    </div>
                                                </div>
                                                <div class="navbar-right">
                                                    <p class="navbar-text">Interna številka:</p>
                                                    <div class="navbar-form navbar-left" role="search">
                                                        <div class="form-group">
                                                            @Html.TextBox("internal", Model.Search.Internal, new { placeholder="Interna št.", id ="quantity2", @class="quantity form-control", maxlength = 6 })
                                                        </div>
                                                        <button type="submit" class="btn btn-primary">Išči...</button>
                                                    </div>
                                                </div>
                                            </div><!-- /.navbar-collapse -->
                                        </div><!-- /.container-fluid -->
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </section>
                
                    <div class="container">                                      
                    <div class="template">
                    <table class="table table-bordered table-striped table-hover">
		                <thead>
			            <tr>
			                <th>Dogodek</th>
			                <th>Poslana dispozicija</th>
			                <th>Luška št.</th>
			                <th>Stanje dispozicije</th>
			                <th>Datum dogodka</th>
			            </tr>
		                </thead>
                        <tbody>
                            @if (Model.Spremenljivke != null)
                            {
                                foreach (var row in Model.Spremenljivke)
                                {
                                    <tr>
                                        <td>[@row.StevilkaDogodek]</td>
                                        <td>@row.Exchangetimestamp.Add(Model.TimeZone.BaseUtcOffset)</td>
                                        <td>@row.Order.FirstOrDefault()</td>
                                        <td>
                                            @String.Join(",", new userDbEntities().KraticeTables.Where(rt => rt.Kratica == row.MsgT.FirstOrDefault()).Select(r => r.OpisSlo).FirstOrDefault() ?? row.MsgT.FirstOrDefault())
                                        </td>
                                        <td>@row.Exchangetimestamp2.Add(Model.TimeZone.BaseUtcOffset)</td>                          
                                    </tr>
                                }
                            }                      
                        </tbody>
		            </table>
                    </div>
		            <div class="row">
		                <div class="col-md-6">
                            @{ Html.RenderPartial("Pagination", new PaginationInfo
                            {
                                PageUrl = Url.SetParameter("page", "!0"),
                                CurrentPage = Model.Search.PageIndex,
                                PageSize = Model.Search.PageSize,
                                TotalItemCount = Model.TotalCount,
                            }); }
		                </div>                               
		                <div class="col-md-6">
		                    <ul class="pagination pull-right">
		                        @{int allItems = Model.TotalCount;}
		                        <li><a href="#">Zadetkov na stran: </a></li>
		                        @{
		                            if (allItems != 0)
		                            {
		                                var arr = new[] {5, 10, 20, 30, @allItems};
		                                for (var i = 0; i < arr.Length; i++)
		                                {
		                                    if (arr[i] == Model.Search.PageSize)
		                                    {
		                                        if (i == arr.Length - 1)
		                                        {<li><a href="#">&raquo;&raquo;</a></li>}
		                                        else 
                                                {<li><a href="#">@arr[i]</a></li>}
		                                    }
		                                    else
		                                    {
		                                    var linkText = (i < arr.Length - 1) ? arr[i].ToString() : ">>";
		                                    <li><a href="@Url.SetParameters(new { pagesize = arr[i], page = 1 })">@linkText</a></li>
		                                    }  
		                                }    
		                            }
		                            else
		                            {
		                                <li><a href="#">--</a></li>
		                            }
		                        }
		                    </ul>
		                </div>
		            </div>
		            <div class="row">
			            <div class="col-md-12">
				            <hr />
				            &copy; Actual I.T., d.d. 
			            </div>
		            </div>	
                    </div><!-- /.container -->
                }
            }
        }
    }
}