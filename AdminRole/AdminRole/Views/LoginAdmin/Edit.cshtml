@model AdminRole.Models.UserModel

@{
    Layout = Request.IsAjaxRequest() ? null : "~/Views/Shared/_Layout.cshtml";
}

@using (Html.BeginForm("Edit", "LoginAdmin", FormMethod.Post, new {id = "user-form"})) {

    @Html.AntiForgeryToken()
    <div class="container top">
        
        <div class="row">
            <div class="col-md-8 col-md-offset-2">
                <div class="page-header"><h2>Edit users</h2></div>
                <div role="form" class="delete-users">
                    <div class="form-group">
                        <label for="us">Username</label>
                        @Html.TextBoxFor(model => model.User.username, new {disabled = "disabled", @readonly = "readonly", @class="form-control", id="us", placeholder="" })
                    </div>
                    
                    <div class="form-group">
                        <label>Time Zone</label>
                        @Html.DropDownListFor(o => o.User.TimeZoneId, TimeZoneInfo.GetSystemTimeZones().Select(o => new SelectListItem{Text = o.DisplayName, Value = o.Id}), new {@class="form-control"})
                        @Html.ValidationMessageFor(model => model.User.TimeZoneId)
                    </div>
                    
                    <div class="form-group">
                        <label>User Role</label>
                        @Html.DropDownList("VlogaNaziv", ((SelectList) ViewBag.DropListVloge).Select(t => new SelectListItem(){Text = t.Text, Value = t.Text, Selected = (t.Text == ViewBag.SelectedVloga)}), Model.VlogaNaziv, new {@class="form-control"})
                    </div>

                    @Html.HiddenFor(model => model.User.userID)
                    @Html.HiddenFor(model => model.User.username)
                    @Html.HiddenFor(model => model.User.password)
                    @Html.HiddenFor(model => model.User.passwordSalt)
                    
                    <div class="row customers">
                        <label class="col-sm-2">Customers</label>
                        <div class="col-sm-8">                            
                            @for (var i=0; i < Model.User.CustomerTables.Count; i++)
                            {
                                <div class="ud">
                                    @Html.DropDownListFor(o => o.User.CustomerTables[i].CustomType.Id_NewCustomerType, Model.GetCustomTypes(Model.User.CustomerTables[i].CustomType.Id_NewCustomerType), "Select", new {@class="form-control pull-left"})
                                    @Html.HiddenFor(o => o.User.CustomerTables[i].CustomerID)
                                    @Html.HiddenFor(o => o.User.CustomerTables[i].UserId)
                                    @Html.HiddenFor(o => o.User.CustomerTables[i].Customer)
                                    <button type="button" class="btn btn-danger pull-left delete-custom" data-id="@i">X</button>   
                                </div>                                                                                           
                            }
                        </div>        
                    </div> 
                    <div class="clearfix"></div> 
                    <div class="form-group">
                        <label>Customer</label>
                        <button class="btn btn-success add-custom">Add Customer</button>
                    </div>
                    <div class="clearfix"></div><br />
                    <input class="btn btn-default pull-left btn-primary" type="submit" name="action" value="Save changes"/>
                    <input class="btn btn-default pull-right btn-primary" type="button" value="Back to Edit Menu" onclick="RedirectToEdit()"/> 
                    <script type="text/javascript">
                        function RedirectToEdit() {
                            var url = "@Url.Action("Registracija")";
                            location.href = url;
                        }
                    </script>    
                </div>               
            </div>            
        </div>
       
        @Html.ValidationSummary(false)
        
        <div class="row">		
            <div class="col-md-12">
                <hr />
                &copy; Actual I.T., d.d. 
            </div>			
        </div>

    </div><!-- /.container -->
}

    <script type="text/javascript">
        $(function () {

            $('.add-custom').on('click', function (e) {
                e.preventDefault();
                var form = $('#user-form').serialize();
                form += "&act=addcustom";

                $.post('/LoginAdmin/Edit', form, function (data) {
                    $('#user-form').replaceWith(data);
                });
            });

            $('.delete-custom').on('click', function (e) {
                e.preventDefault();
                var form = $('#user-form').serialize();
                form += "&act=deletecustom&idx=" + $(this).data('id');

                $.post('/LoginAdmin/Edit', form, function (data) {
                    $('#user-form').replaceWith(data);
                });
            });

            $("#user-form").submit(function (e) {
                e.preventDefault();
                var form = $('#user-form').serialize();
                form += "&act=save";
                $.post('/LoginAdmin/Edit', form, function (data) {
                    if (data == "success")
                        Redirect();
                    else
                        $('#user-form').replaceWith(data);
                });
            });

        });

        function Redirect() {
            var url = "@Url.Action("Registracija")";
            location.href = url;
        }

    </script>

